# Keystone Lua Engine Makefile

.PHONY: help build run test clean docker-build docker-run deps fmt lint

# Colors for output
CYAN := \033[36m
GREEN := \033[32m
YELLOW := \033[33m
RED := \033[31m
RESET := \033[0m

# Variables
BINARY_NAME := lua-engine
DOCKER_IMAGE := keystone-lua-engine
PORT := 8081

help: ## Show this help message
	@echo "$(CYAN)Keystone Lua Engine$(RESET)"
	@echo "$(CYAN)==================$(RESET)"
	@echo ""
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "$(GREEN)%-15s$(RESET) %s\n", $$1, $$2}'

deps: ## Download dependencies
	@echo "$(CYAN)â¬‡ï¸  Downloading dependencies...$(RESET)"
	go mod download
	go mod tidy

build: deps ## Build the lua engine binary
	@echo "$(CYAN)ğŸ”¨ Building lua engine...$(RESET)"
	go build -o $(BINARY_NAME) .
	@echo "$(GREEN)âœ… Build completed: $(BINARY_NAME)$(RESET)"

run: build ## Run the lua engine locally
	@echo "$(CYAN)ğŸš€ Starting lua engine on port $(PORT)...$(RESET)"
	./$(BINARY_NAME) -addr :$(PORT) -scripts ../scripts

dev: ## Run in development mode with auto-reload
	@echo "$(CYAN)ğŸ”§ Starting development mode...$(RESET)"
	@which air > /dev/null || (echo "$(YELLOW)Installing air for hot reload...$(RESET)" && go install github.com/cosmtrek/air@latest)
	air -c .air.toml

test: ## Run tests
	@echo "$(CYAN)ğŸ§ª Running tests...$(RESET)"
	go test -v ./...

fmt: ## Format code
	@echo "$(CYAN)ğŸ“ Formatting code...$(RESET)"
	go fmt ./...

lint: ## Run linter
	@echo "$(CYAN)ğŸ” Running linter...$(RESET)"
	@which golangci-lint > /dev/null || (echo "$(YELLOW)Installing golangci-lint...$(RESET)" && go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest)
	golangci-lint run

docker-build: ## Build Docker image
	@echo "$(CYAN)ğŸ³ Building Docker image...$(RESET)"
	docker build -t $(DOCKER_IMAGE) .
	@echo "$(GREEN)âœ… Docker image built: $(DOCKER_IMAGE)$(RESET)"

docker-run: docker-build ## Run in Docker container
	@echo "$(CYAN)ğŸ³ Running in Docker container...$(RESET)"
	docker run -p $(PORT):$(PORT) -v $(PWD)/../scripts:/app/scripts $(DOCKER_IMAGE)

docker-shell: ## Get shell in Docker container
	@echo "$(CYAN)ğŸ³ Opening shell in container...$(RESET)"
	docker run -it --entrypoint /bin/sh $(DOCKER_IMAGE)

benchmark: ## Run performance benchmarks
	@echo "$(CYAN)ğŸ“Š Running benchmarks...$(RESET)"
	go test -bench=. -benchmem ./...

scripts-validate: ## Validate all Lua scripts
	@echo "$(CYAN)âœ… Validating Lua scripts...$(RESET)"
	@for script in ../scripts/*.lua; do \
		echo "Checking $$script..."; \
		lua -l $$script 2>/dev/null || echo "$(RED)âŒ Syntax error in $$script$(RESET)"; \
	done
	@echo "$(GREEN)âœ… Script validation completed$(RESET)"

clean: ## Clean build artifacts
	@echo "$(CYAN)ğŸ§¹ Cleaning...$(RESET)"
	rm -f $(BINARY_NAME)
	docker rmi $(DOCKER_IMAGE) 2>/dev/null || true
	@echo "$(GREEN)âœ… Cleanup completed$(RESET)"

health: ## Check if lua engine is running
	@echo "$(CYAN)ğŸ¥ Checking health...$(RESET)"
	@curl -s http://localhost:$(PORT)/health | jq . || echo "$(RED)âŒ Lua engine not running$(RESET)"

reload: ## Reload scripts in running engine
	@echo "$(CYAN)ğŸ”„ Reloading scripts...$(RESET)"
	@curl -s -X POST http://localhost:$(PORT)/reload | jq . || echo "$(RED)âŒ Failed to reload scripts$(RESET)"

logs: ## Show Docker container logs
	@echo "$(CYAN)ğŸ“‹ Container logs:$(RESET)"
	docker logs $$(docker ps -q --filter ancestor=$(DOCKER_IMAGE)) -f

# Default target
.DEFAULT_GOAL := help
