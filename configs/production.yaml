# Production Configuration for Keystone Gateway
# Environment: Production
# Last Updated: 2025-07-19

# Server Configuration
server:
  port: 8080
  read_timeout: 30s
  write_timeout: 30s
  idle_timeout: 120s
  max_header_bytes: 1048576

# Admin Configuration
admin:
  enabled: true
  base_path: "/admin"
  auth:
    enabled: true
    username: "admin"
    password: "opfeorpfer2"

# Routing Configuration
routing:
  # Host-based routing rules
  hosts:
    # Demo Application
    "demo.keystone-gateway.dev":
      upstream: "http://demo-backend:80"
      health_check: "/health"
      load_balancer: "round_robin"
      timeout: 30s
      retry_attempts: 3
      retry_delay: 1s

    # API Service
    "api.keystone-gateway.dev":
      upstream: "http://api-backend:3000"
      health_check: "/health"
      load_balancer: "round_robin"
      timeout: 30s
      retry_attempts: 3
      retry_delay: 1s

    # Authentication Service  
    "auth.keystone-gateway.dev":
      upstream: "http://auth-backend:3000"
      health_check: "/health"
      load_balancer: "round_robin"
      timeout: 30s
      retry_attempts: 3
      retry_delay: 1s

    # Status/Monitoring Service
    "status.keystone-gateway.dev":
      upstream: "http://status-backend:80"
      health_check: "/health"
      load_balancer: "round_robin"
      timeout: 30s
      retry_attempts: 3
      retry_delay: 1s

    # Grafana Monitoring
    "grafana.keystone-gateway.dev":
      upstream: "http://grafana:3000"
      health_check: "/api/health"
      load_balancer: "round_robin"
      timeout: 60s
      retry_attempts: 2
      retry_delay: 2s

  # Path-based routing rules
  paths:
    # API v1 routing
    "/api/v1":
      upstream: "http://api-backend:3000"
      strip_prefix: true
      health_check: "/health"
      
    # API v2 routing
    "/api/v2":
      upstream: "http://api-backend:3000" 
      strip_prefix: true
      health_check: "/health"

    # Authentication endpoints
    "/auth":
      upstream: "http://auth-backend:3000"
      strip_prefix: true
      health_check: "/health"

# Middleware Configuration
middleware:
  # CORS Configuration
  cors:
    enabled: true
    allowed_origins:
      - "https://demo.keystone-gateway.dev"
      - "https://api.keystone-gateway.dev"
      - "https://auth.keystone-gateway.dev"
      - "https://status.keystone-gateway.dev"
      - "https://grafana.keystone-gateway.dev"
    allowed_methods:
      - "GET"
      - "POST"
      - "PUT"
      - "DELETE"
      - "PATCH"
      - "OPTIONS"
    allowed_headers:
      - "Origin"
      - "Content-Type"
      - "Accept"
      - "Authorization"
      - "X-Requested-With"
      - "X-API-Key"
    allow_credentials: true
    max_age: 86400

  # Rate Limiting
  rate_limit:
    enabled: true
    requests_per_minute: 1000
    burst_size: 100
    ip_whitelist:
      - "127.0.0.1"
      - "::1"

  # Security Headers
  security:
    enabled: true
    headers:
      X-Frame-Options: "DENY"
      X-Content-Type-Options: "nosniff"
      X-XSS-Protection: "1; mode=block"
      Strict-Transport-Security: "max-age=31536000; includeSubDomains"
      Referrer-Policy: "strict-origin-when-cross-origin"
      Content-Security-Policy: "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'"

  # Request/Response Logging
  logging:
    enabled: true
    level: "info"
    format: "json"
    include_request_body: false
    include_response_body: false
    exclude_paths:
      - "/health"
      - "/admin/health"
      - "/metrics"

  # Metrics and Monitoring
  metrics:
    enabled: true
    path: "/metrics"
    namespace: "keystone_gateway"

# Health Check Configuration
health:
  enabled: true
  path: "/health"
  timeout: 10s
  interval: 30s
  
# Circuit Breaker Configuration
circuit_breaker:
  enabled: true
  failure_threshold: 5
  recovery_timeout: 30s
  max_requests: 10

# Load Balancer Configuration
load_balancer:
  strategy: "round_robin"
  health_check_interval: 30s
  health_check_timeout: 10s
  max_idle_connections: 100
  max_connections_per_host: 50

# TLS Configuration (handled by Traefik in production)
tls:
  enabled: false  # Traefik handles SSL termination
  auto_redirect: false  # Traefik handles HTTP->HTTPS redirect

# Cache Configuration
cache:
  enabled: true
  type: "redis"
  redis:
    addr: "redis:6379"
    password: "opferopfer2"
    db: 0
    max_retries: 3
    pool_size: 10
    min_idle_connections: 5
    max_connection_age: 3600s

# Session Configuration
session:
  enabled: true
  store: "redis"
  redis:
    addr: "redis:6379"
    password: "opferopfer2"
    db: 1
  cookie:
    name: "keystone_session"
    domain: ".keystone-gateway.dev"
    secure: true
    http_only: true
    same_site: "lax"
    max_age: 86400

# Database Configuration
database:
  enabled: true
  driver: "postgres"
  dsn: "postgres://keystone:opferopfer2@postgres:5432/keystonedb?sslmode=require"
  max_open_connections: 25
  max_idle_connections: 5
  max_connection_lifetime: 3600s

# Logging Configuration
log:
  level: "info"
  format: "json"
  output: "stdout"
  file:
    enabled: true
    path: "/app/logs/keystone-gateway.log"
    max_size: 100
    max_backups: 7
    max_age: 30
    compress: true

# Production Optimizations
production:
  # Performance tuning
  max_workers: 0  # Use all available CPU cores
  read_buffer_size: 4096
  write_buffer_size: 4096
  
  # Security
  hide_server_header: true
  disable_server_header: true
  
  # Monitoring
  profiling_enabled: false  # Disable in production for security
  debug_mode: false